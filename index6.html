<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEET PG Accountability Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
        }
        .message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-10 px-4">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, onSnapshot, collection, query, where, serverTimestamp, setLogLevel, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Message box UI element
        const messageBox = document.getElementById('message-box');
        const showMessage = (message, type = 'info') => {
            messageBox.textContent = message;
            messageBox.className = `message-box p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        };

        let db;
        let auth;
        let userId = null;
        let unsubscribe = null;
        
        // Initial setup on window load
        window.onload = async function() {
            setLogLevel('debug');
            
            // NOTE: When running this file on your local machine, you must manually
            // add your Firebase configuration here.
            // 1. Go to your Firebase project console.
            // 2. Select Project Settings > Your apps.
            // 3. Click "Config" and copy the object.
            // 4. Paste it below and uncomment the `const localFirebaseConfig` line.

            // Example:
            const localFirebaseConfig = {
  apiKey: "AIzaSyAWsR8Q7PalXP2Yo0D_62LH1y3a-lVRwNs",
  authDomain: "neet-pg-accountability.firebaseapp.com",
  databaseURL: "https://neet-pg-accountability-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "neet-pg-accountability",
  storageBucket: "neet-pg-accountability.firebasestorage.app",
  messagingSenderId: "248678627903",
  appId: "1:248678627903:web:f20558585e14b9e99c168a"
};

            // Use the local config if the environment one is not available
            const finalFirebaseConfig = Object.keys(firebaseConfig).length > 0 ? firebaseConfig : localFirebaseConfig;

            if (finalFirebaseConfig) {
                const app = initializeApp(finalFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Authenticate the user
                if (initialAuthToken) {
                    try {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } catch (error) {
                        console.error("Error signing in with custom token:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        await signInAnonymously(auth);
                    }
                } else {
                    // Directly use anonymous sign-in when no custom token is available
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes and initialize app
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        // Start listening for data once authenticated
                        startRealtimeListener();
                    } else {
                        showMessage('Authentication failed. Please try again.', 'error');
                        console.error('Authentication failed.');
                    }
                });
            } else {
                showMessage('Firebase config not found. Please add your config to the file.', 'error');
                console.error("Firebase config not found.");
            }
        };

        const logStudy = async () => {
            if (!auth.currentUser) {
                await signInAnonymously(auth);
                showMessage('Authenticating user, please try again.', 'info');
                return;
            }
            const userId = auth.currentUser.uid;

            const hours = document.getElementById('hours-input').value;
            const topics = document.getElementById('topics-input').value;
            const name = document.getElementById('name-input').value;
            const mcqs = document.getElementById('mcqs-input').value;
            const exercise = document.getElementById('exercise-input').value;

            if (hours === '' || topics === '' || name === '' || mcqs === '' || exercise === '') {
                showMessage('Please fill in all fields.', 'error');
                return;
            }
            if (isNaN(parseFloat(hours))) {
                showMessage('Hours must be a number.', 'error');
                return;
            }
            if (isNaN(parseInt(mcqs))) {
                showMessage('MCQs must be a number.', 'error');
                return;
            }

            // Normalize the name before saving it to the database
            const normalizedName = name.trim().toLowerCase();

            const studyData = {
                userId: userId,
                name: normalizedName,
                hours: parseFloat(hours),
                topics: topics,
                mcqs: parseInt(mcqs),
                exercise: exercise,
                date: serverTimestamp(),
                timestamp: new Date().toISOString()
            };

            const collectionPath = `/artifacts/${appId}/public/data/study_logs`;
            const studyLogsRef = collection(db, collectionPath);

            try {
                await addDoc(studyLogsRef, studyData);
                document.getElementById('hours-input').value = '';
                document.getElementById('topics-input').value = '';
                document.getElementById('mcqs-input').value = '';
                document.getElementById('exercise-input').value = '';
                showMessage('Study logged successfully!', 'success');
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage('Error logging study.', 'error');
            }
        };

        const startRealtimeListener = async () => {
            if (!auth.currentUser || unsubscribe) {
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                return;
            }
            const collectionPath = `/artifacts/${appId}/public/data/study_logs`;
            const studyLogsRef = collection(db, collectionPath);
            const q = query(studyLogsRef);

            unsubscribe = onSnapshot(q, (querySnapshot) => {
                const logs = [];
                querySnapshot.forEach((doc) => {
                    logs.push(doc.data());
                });
                updateCharts(logs);
            }, (error) => {
                console.error("Error listening to collection:", error);
                showMessage('Error fetching data.', 'error');
            });
        };

        const updateCharts = (logs) => {
            // Process data for daily chart
            const dailyData = {};
            const today = new Date();
            const todayISO = today.toISOString().slice(0, 10);
            logs.forEach(log => {
                const logDate = log.timestamp ? log.timestamp.slice(0, 10) : todayISO;
                if (logDate === todayISO) {
                    if (!dailyData[log.name]) {
                        dailyData[log.name] = { hours: 0, mcqs: 0 };
                    }
                    dailyData[log.name].hours += log.hours;
                    dailyData[log.name].mcqs += log.mcqs;
                }
            });

            // Process data for weekly chart
            const weeklyData = {};
            const now = new Date();
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (now.getDay()));
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            logs.forEach(log => {
                const logDate = log.timestamp ? new Date(log.timestamp) : new Date();
                if (logDate >= startOfWeek && logDate <= endOfWeek) {
                    if (!weeklyData[log.name]) {
                        weeklyData[log.name] = { hours: 0, mcqs: 0 };
                    }
                    weeklyData[log.name].hours += log.hours;
                    weeklyData[log.name].mcqs += log.mcqs;
                }
            });
            
            // Process data for monthly chart
            const monthlyData = {};
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            logs.forEach(log => {
                const logDate = log.timestamp ? new Date(log.timestamp) : new Date();
                if (logDate >= startOfMonth) {
                    if (!monthlyData[log.name]) {
                        monthlyData[log.name] = { hours: 0, mcqs: 0 };
                    }
                    monthlyData[log.name].hours += log.hours;
                    monthlyData[log.name].mcqs += log.mcqs;
                }
            });

            document.getElementById('loading').classList.add('hidden');
            
            // Render all charts
            const todayDateString = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            renderCombinedChart('progressChartDaily', dailyData);
            document.getElementById('daily-chart-title').textContent = `Daily Progress (${todayDateString})`;
            
            const weeklyRangeString = `${startOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endOfWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            renderCombinedChart('progressChartWeekly', weeklyData);
            document.getElementById('weekly-chart-title').textContent = `Weekly Progress (${weeklyRangeString})`;
            
            const monthlyRangeString = `${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
            renderCombinedChart('progressChartMonthly', monthlyData);
            document.getElementById('monthly-chart-title').textContent = `Monthly Progress (${monthlyRangeString})`;
            
            // Initial view set to daily
            toggleView('daily');
        };

        const renderCombinedChart = (canvasId, data) => {
            const ctx = document.getElementById(canvasId).getContext('2d');
            let existingChart = Chart.getChart(ctx);
            if (existingChart) {
                existingChart.destroy();
            }

            const labels = Object.keys(data);
            const hoursData = labels.map(label => data[label].hours);
            const mcqsData = labels.map(label => data[label].mcqs);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Hours Studied',
                            data: hoursData,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            borderRadius: 10,
                            yAxisID: 'y'
                        },
                        {
                            label: 'MCQs Solved',
                            data: mcqsData,
                            type: 'line',
                            borderColor: 'rgb(249, 115, 22)',
                            backgroundColor: 'rgba(249, 115, 22, 0.2)',
                            fill: false,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Hours'
                            },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'MCQs'
                            },
                            grid: {
                                drawOnChartArea: false
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        };

        window.logStudy = logStudy;
        window.toggleView = (viewType) => {
            const formView = document.getElementById('form-view');
            const progressView = document.getElementById('progress-view');
            const dailyChartContainer = document.getElementById('daily-chart-container');
            const weeklyChartContainer = document.getElementById('weekly-chart-container');
            const monthlyChartContainer = document.getElementById('monthly-chart-container');
            const logBtn = document.getElementById('log-btn');
            const dailyBtn = document.getElementById('daily-progress-btn');
            const weeklyBtn = document.getElementById('weekly-progress-btn');
            const monthlyBtn = document.getElementById('monthly-progress-btn');

            if (viewType === 'log') {
                formView.classList.remove('hidden');
                progressView.classList.add('hidden');
                logBtn.classList.add('bg-blue-600', 'text-white');
                dailyBtn.classList.remove('bg-blue-600', 'text-white');
                dailyBtn.classList.add('bg-gray-400', 'text-white');
                weeklyBtn.classList.remove('bg-blue-600', 'text-white');
                weeklyBtn.classList.add('bg-gray-400', 'text-white');
                monthlyBtn.classList.remove('bg-blue-600', 'text-white');
                monthlyBtn.classList.add('bg-gray-400', 'text-white');
            } else {
                formView.classList.add('hidden');
                progressView.classList.remove('hidden');
                logBtn.classList.remove('bg-blue-600');
                logBtn.classList.add('bg-gray-400');
                
                dailyChartContainer.classList.add('hidden');
                weeklyChartContainer.classList.add('hidden');
                monthlyChartContainer.classList.add('hidden');

                if (viewType === 'daily') {
                    dailyChartContainer.classList.remove('hidden');
                    dailyBtn.classList.add('bg-blue-600', 'text-white');
                    weeklyBtn.classList.remove('bg-blue-600', 'text-white');
                    weeklyBtn.classList.add('bg-gray-400', 'text-white');
                    monthlyBtn.classList.remove('bg-blue-600', 'text-white');
                    monthlyBtn.classList.add('bg-gray-400', 'text-white');
                } else if (viewType === 'weekly') {
                    weeklyChartContainer.classList.remove('hidden');
                    weeklyBtn.classList.add('bg-blue-600', 'text-white');
                    dailyBtn.classList.remove('bg-blue-600', 'text-white');
                    dailyBtn.classList.add('bg-gray-400', 'text-white');
                    monthlyBtn.classList.remove('bg-blue-600', 'text-white');
                    monthlyBtn.classList.add('bg-gray-400', 'text-white');
                } else if (viewType === 'monthly') {
                    monthlyChartContainer.classList.remove('hidden');
                    monthlyBtn.classList.add('bg-blue-600', 'text-white');
                    dailyBtn.classList.remove('bg-blue-600', 'text-white');
                    dailyBtn.classList.add('bg-gray-400', 'text-white');
                    weeklyBtn.classList.remove('bg-blue-600', 'text-white');
                    weeklyBtn.classList.add('bg-gray-400', 'text-white');
                }
            }
        };
    </script>

    <div id="message-box" class="hidden"></div>

    <div class="container bg-white p-8 rounded-2xl shadow-xl flex flex-col items-center space-y-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800">NEET PG Accountability</h1>
        <p class="text-sm text-gray-500 text-center">User ID: <span id="user-id" class="font-mono text-xs">Initializing...</span></p>

        <!-- Navigation Buttons -->
        <div class="flex flex-wrap justify-center gap-4 w-full">
            <button id="log-btn" onclick="toggleView('log')" class="flex-1 py-3 px-6 rounded-xl font-bold transition-colors bg-blue-600 text-white shadow-lg">Log Study</button>
            <button id="daily-progress-btn" onclick="toggleView('daily')" class="flex-1 py-3 px-6 rounded-xl font-bold transition-colors bg-gray-400 text-white shadow-lg">Daily Progress</button>
            <button id="weekly-progress-btn" onclick="toggleView('weekly')" class="flex-1 py-3 px-6 rounded-xl font-bold transition-colors bg-gray-400 text-white shadow-lg">Weekly Progress</button>
            <button id="monthly-progress-btn" onclick="toggleView('monthly')" class="flex-1 py-3 px-6 rounded-xl font-bold transition-colors bg-gray-400 text-white shadow-lg">Monthly Progress</button>
        </div>

        <!-- Data Entry Form -->
        <div id="form-view" class="w-full space-y-6">
            <div class="space-y-2">
                <label for="name-input" class="text-gray-700 font-medium">Your Name:</label>
                <input type="text" id="name-input" placeholder="e.g., Friend A" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="space-y-2">
                <label for="hours-input" class="text-gray-700 font-medium">Hours Studied:</label>
                <input type="number" id="hours-input" placeholder="e.g., 6.5" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="space-y-2">
                <label for="mcqs-input" class="text-gray-700 font-medium">MCQs Solved:</label>
                <input type="number" id="mcqs-input" placeholder="e.g., 100" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="space-y-2">
                <label for="exercise-input" class="text-gray-700 font-medium">Exercise:</label>
                <input type="text" id="exercise-input" placeholder="e.g., 30 min run" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="space-y-2">
                <label for="topics-input" class="text-gray-700 font-medium">Topics Covered:</label>
                <textarea id="topics-input" rows="3" placeholder="e.g., Anatomy, Pathology" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
            </div>
            <button onclick="logStudy()" class="w-full py-4 px-6 rounded-xl bg-blue-600 text-white font-bold text-lg shadow-lg hover:bg-blue-700 transition-colors">
                Submit
            </button>
        </div>

        <!-- Progress Graphs Container -->
        <div id="progress-view" class="w-full hidden flex flex-col items-center space-y-4">
            <div id="loading" class="text-gray-500 text-center">Loading chart data...</div>

            <!-- Daily Progress Chart -->
            <div id="daily-chart-container" class="w-full hidden">
                <h2 id="daily-chart-title" class="text-2xl font-semibold text-gray-800 text-center mb-4">Daily Progress</h2>
                <div class="chart-container">
                    <canvas id="progressChartDaily"></canvas>
                </div>
            </div>

            <!-- Weekly Progress Chart -->
            <div id="weekly-chart-container" class="w-full hidden">
                <h2 id="weekly-chart-title" class="text-2xl font-semibold text-gray-800 text-center mb-4">Weekly Progress</h2>
                <div class="chart-container">
                    <canvas id="progressChartWeekly"></canvas>
                </div>
            </div>

            <!-- Monthly Progress Chart -->
            <div id="monthly-chart-container" class="w-full hidden">
                <h2 id="monthly-chart-title" class="text-2xl font-semibold text-gray-800 text-center mb-4">Monthly Progress</h2>
                <div class="chart-container">
                    <canvas id="progressChartMonthly"></canvas>
                </div>
            </div>
        </div>

    </div>
</body>
</html>
