<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NEET PG Accountability Tracker (Stable)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Poppins', sans-serif; background-color: #0f172a; }
    .card { background-color: #0b1220; color: #e2e8f0; }
    .chart-container { position: relative; height: 400px; width: 100%; }
    .message-box { position: fixed; top: 20px; right: 20px; z-index: 1000; }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

  <!-- Message Toast -->
  <div id="message-box" class="hidden"></div>

  <!-- Wrapper -->
  <div class="container max-w-3xl card p-8 rounded-2xl shadow-2xl flex flex-col items-center space-y-8 border border-gray-700">
    <h1 class="text-3xl sm:text-4xl font-bold text-center text-white">NEET PG Accountability</h1>
    <p class="text-xs text-gray-400">User ID: <span id="user-id" class="font-mono text-gray-200">...</span></p>

    <!-- Navigation -->
    <div class="flex flex-wrap justify-center gap-2 w-full">
      <button id="log-btn" onclick="toggleView('log')" class="flex-1 py-2 px-4 rounded-lg bg-blue-600 text-white">Log Study</button>
      <button id="daily-progress-btn" onclick="toggleView('daily')" class="flex-1 py-2 px-4 rounded-lg bg-gray-600 text-white">Daily</button>
      <button id="weekly-progress-btn" onclick="toggleView('weekly')" class="flex-1 py-2 px-4 rounded-lg bg-gray-600 text-white">Weekly</button>
      <button id="monthly-progress-btn" onclick="toggleView('monthly')" class="flex-1 py-2 px-4 rounded-lg bg-gray-600 text-white">Monthly</button>
    </div>

    <!-- Input Form -->
    <div id="form-view" class="w-full space-y-4">
      <input type="text" id="name-input" placeholder="Your Name" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white" />
      <input type="number" id="hours-input" step="0.1" placeholder="Hours Studied" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white" />
      <input type="number" id="mcqs-input" placeholder="MCQs Solved" class="w-full p-3 rounded-lg bg-gray-800 border border-gray-600 text-white" />
      <button onclick="logStudy()" class="w-full py-3 rounded-lg bg-blue-600 text-white font-bold">Submit</button>
    </div>

    <!-- Charts -->
    <div id="progress-view" class="w-full hidden flex flex-col space-y-6">
      <div id="loading" class="text-gray-400 text-center">Loading data...</div>

      <div id="daily-chart-container" class="hidden">
        <h2 id="daily-chart-title" class="text-xl text-center text-white mb-2">Daily Progress</h2>
        <div class="chart-container card p-4 rounded-xl"><canvas id="progressChartDaily"></canvas></div>
      </div>

      <div id="weekly-chart-container" class="hidden">
        <h2 id="weekly-chart-title" class="text-xl text-center text-white mb-2">Weekly Progress</h2>
        <div class="chart-container card p-4 rounded-xl"><canvas id="progressChartWeekly"></canvas></div>
      </div>

      <div id="monthly-chart-container" class="hidden">
        <h2 id="monthly-chart-title" class="text-xl text-center text-white mb-2">Monthly Progress</h2>
        <div class="chart-container card p-4 rounded-xl"><canvas id="progressChartMonthly"></canvas></div>
        <div id="monthly-averages" class="hidden mt-4 card p-4 rounded-lg border border-gray-700"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Helpers
    const localISODate = (d) => d.toISOString().split('T')[0];
    const showMessage = (msg, type='info') => {
      const box = document.getElementById('message-box');
      box.textContent = msg;
      box.className = `message-box p-3 rounded ${type==='success'?'bg-green-600':'bg-blue-600'} text-white`;
      box.style.display = 'block';
      setTimeout(()=> box.style.display='none', 2500);
    };

    // Extended palette
    const colorPalette = [
      '#3b82f6','#f97316','#10b981','#ef4444','#8b5cf6','#06b6d4','#f59e0b',
      '#14b8a6','#a855f7','#ec4899','#22c55e','#eab308','#0ea5e9','#f87171','#4ade80'
    ];
    const getColorForUser = (name) => {
      let hash=0; for (let i=0;i<name.length;i++) hash=name.charCodeAt(i)+((hash<<5)-hash);
      return colorPalette[Math.abs(hash)%colorPalette.length];
    };

    // Firebase init
    const app = initializeApp({
      apiKey: "AIzaSyAWsR8Q7PalXP2Yo0D_62LH1y3a-lVRwNs",
      authDomain: "neet-pg-accountability.firebaseapp.com",
      projectId: "neet-pg-accountability",
      storageBucket: "neet-pg-accountability.appspot.com",
      messagingSenderId: "248678627903",
      appId: "1:248678627903:web:f20558585e14b9e99c168a"
    });
    const db = getFirestore(app);
    const auth = getAuth(app);

    let logsCache=[], lastRenderedDate=localISODate(new Date());
    let chartDaily=null, chartWeekly=null, chartMonthly=null;

    onAuthStateChanged(auth, user=>{
      if(user){ document.getElementById('user-id').textContent=user.uid; startRealtimeListener(); }
      else signInAnonymously(auth);
    });
    signInAnonymously(auth);

    window.logStudy = async () => {
      const hours=parseFloat(document.getElementById('hours-input').value);
      const mcqs=parseInt(document.getElementById('mcqs-input').value);
      const name=document.getElementById('name-input').value.trim();
      if(!hours||!mcqs||!name) return showMessage("Fill all fields","error");

      const now=new Date();
      const log={userId:auth.currentUser.uid,name,hours,mcqs,dateISO:localISODate(now),timestampISO:now.toISOString(),server_ts:serverTimestamp()};
      try{ await addDoc(collection(db,"study_logs"),log); showMessage("Logged!","success"); }
      catch(e){ console.error(e); showMessage("Error","error"); }
    };

    const startRealtimeListener=()=>{
      const q=query(collection(db,"study_logs"));
      onSnapshot(q,snap=>{
        logsCache=snap.docs.map(d=>d.data());
        updateCharts();
      });
    };

    const updateCharts=()=>{
      const todayISO=localISODate(new Date()), now=new Date();
      const startOfWeek=new Date(now); startOfWeek.setDate(now.getDate()-now.getDay());
      const endOfWeek=new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate()+6);
      const startOfMonth=new Date(now.getFullYear(),now.getMonth(),1);

      const daily={},weekly={},monthly={};
      logsCache.forEach(log=>{
        const logDate=new Date(log.timestampISO||log.dateISO);
        if(log.dateISO===todayISO){ (daily[log.name]??={hours:0,mcqs:0}); daily[log.name].hours+=log.hours; daily[log.name].mcqs+=log.mcqs; }
        if(logDate>=startOfWeek && logDate<=endOfWeek){ (weekly[log.name]??={hours:0,mcqs:0}); weekly[log.name].hours+=log.hours; weekly[log.name].mcqs+=log.mcqs; }
        if(logDate>=startOfMonth){ (monthly[log.name]??={hours:0,mcqs:0}); monthly[log.name].hours+=log.hours; monthly[log.name].mcqs+=log.mcqs; }
      });

      renderChart("progressChartDaily",daily,"Daily Progress",todayISO,'daily');
      renderChart("progressChartWeekly",weekly,"Weekly Progress",'', 'weekly');
      renderChart("progressChartMonthly",monthly,"Monthly Progress",'','monthly');
    };

    const renderChart=(id,data,title,dateStr,kind)=>{
      const ctx=document.getElementById(id).getContext("2d");
      const prev=Chart.getChart(ctx); if(prev) prev.destroy();
      const labels=Object.keys(data), hours=labels.map(l=>data[l].hours), mcqs=labels.map(l=>data[l].mcqs);
      const colors=labels.map(l=>getColorForUser(l));
      const chart=new Chart(ctx,{type:"bar",data:{labels,datasets:[
        {label:"Hours",data:hours,backgroundColor:colors,yAxisID:'y'},
        {label:"MCQs",data:mcqs,type:'line',borderColor:'#f97316',tension:0.3,yAxisID:'y1'}
      ]},options:{responsive:true,scales:{y:{beginAtZero:true},y1:{beginAtZero:true,position:'right'}}}});
      if(kind==="daily") chartDaily=chart;
      if(kind==="weekly") chartWeekly=chart;
      if(kind==="monthly") chartMonthly=chart;
      document.getElementById(id).parentElement.parentElement.classList.remove("hidden");
    };

    // Midnight auto-refresh
    setInterval(()=>{
      const today=localISODate(new Date());
      if(today!==lastRenderedDate){ lastRenderedDate=today; updateCharts(); }
    },60000);

    window.toggleView=(view)=>{
      document.getElementById('form-view').classList.add('hidden');
      document.getElementById('progress-view').classList.remove('hidden');
      ['daily','weekly','monthly'].forEach(k=>document.getElementById(`${k}-chart-container`).classList.add('hidden'));
      if(view==='log'){ document.getElementById('form-view').classList.remove('hidden'); document.getElementById('progress-view').classList.add('hidden'); }
      if(view==='daily') document.getElementById('daily-chart-container').classList.remove('hidden');
      if(view==='weekly') document.getElementById('weekly-chart-container').classList.remove('hidden');
      if(view==='monthly') document.getElementById('monthly-chart-container').classList.remove('hidden');
    };
  </script>
</body>
</html>
