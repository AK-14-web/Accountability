<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
  import { getFirestore, collection, addDoc, query, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "YOUR_FIREBASE_API_KEY",
    authDomain: "YOUR_FIREBASE_PROJECT.firebaseapp.com",
    projectId: "YOUR_FIREBASE_PROJECT",
    storageBucket: "YOUR_FIREBASE_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let logsCache = [];
  let lastRenderedDate = null;

  // ðŸŽ¨ Color palette (consistent per user)
  const colorPalette = ["#3b82f6","#f97316","#10b981","#ef4444","#8b5cf6","#14b8a6","#eab308","#ec4899"];
  const getColorForUser = (username) => {
    const hash = username.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
    return colorPalette[hash % colorPalette.length];
  };

  // Sign in anonymous
  signInAnonymously(auth).catch(console.error);

  // Save log
  const form = document.getElementById('log-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const name = document.getElementById('name-input').value.trim();
    const hours = parseFloat(document.getElementById('hours-input').value) || 0;
    const mcqs = parseInt(document.getElementById('mcqs-input').value) || 0;

    if (!name) return alert("Enter your name!");

    // Save name to localStorage
    localStorage.setItem("username", name);

    // Today's date string
    const todayISO = new Date().toISOString().split('T')[0];

    try {
      await addDoc(collection(db, "study_logs"), {
        name: name,
        hours: hours,
        mcqs: mcqs,
        dateISO: todayISO,
        timestampISO: new Date().toISOString()
      });

      document.getElementById('hours-input').value = '';
      document.getElementById('mcqs-input').value = '';
    } catch (err) {
      console.error("Error adding log:", err);
    }
  });

  // Prefill saved name
  const savedName = localStorage.getItem("username");
  if (savedName) document.getElementById('name-input').value = savedName;

  // Listen to logs
  const logsQuery = query(collection(db, "study_logs"), orderBy("timestampISO", "desc"));
  onSnapshot(logsQuery, (snapshot) => {
    logsCache = snapshot.docs.map(doc => doc.data());
    renderAggregatedCharts(logsCache);
  });

  // Render charts
  function renderAggregatedCharts(logs) {
    const todayDateISO = new Date().toISOString().split('T')[0];

    // --- DAILY ---
    const dailyData = {};
    logs.forEach(log => {
      const logDateISO = log.dateISO || (log.timestampISO ? log.timestampISO.split('T')[0] : null);
      if (logDateISO === todayDateISO) {
        if (!dailyData[log.name]) dailyData[log.name] = { hours: 0, mcqs: 0 };
        dailyData[log.name].hours += log.hours;
        dailyData[log.name].mcqs += log.mcqs;
      }
    });
    renderCombinedChart(dailyData, 'daily-chart', 'Daily Progress');

    // --- WEEKLY ---
    const weeklyData = {};
    const now = new Date();
    logs.forEach(log => {
      const logDateISO = log.dateISO || (log.timestampISO ? log.timestampISO.split('T')[0] : null);
      if (logDateISO) {
        const logDate = new Date(logDateISO);
        const diffDays = (now - logDate) / (1000 * 60 * 60 * 24);
        if (diffDays <= 7) {
          if (!weeklyData[log.name]) weeklyData[log.name] = { hours: 0, mcqs: 0 };
          weeklyData[log.name].hours += log.hours;
          weeklyData[log.name].mcqs += log.mcqs;
        }
      }
    });
    renderCombinedChart(weeklyData, 'weekly-chart', 'Weekly Progress');

    // --- MONTHLY ---
    const monthlyData = {};
    logs.forEach(log => {
      const logDateISO = log.dateISO || (log.timestampISO ? log.timestampISO.split('T')[0] : null);
      if (logDateISO) {
        const logDate = new Date(logDateISO);
        const diffDays = (now - logDate) / (1000 * 60 * 60 * 24);
        if (diffDays <= 30) {
          if (!monthlyData[log.name]) monthlyData[log.name] = { hours: 0, mcqs: 0 };
          monthlyData[log.name].hours += log.hours;
          monthlyData[log.name].mcqs += log.mcqs;
        }
      }
    });
    renderCombinedChart(monthlyData, 'monthly-chart', 'Monthly Progress');

    // Monthly Averages
    const avgTable = document.getElementById("monthly-averages");
    if (avgTable) avgTable.remove(); // reset
    const table = document.createElement("table");
    table.id = "monthly-averages";
    table.className = "mt-4 w-full text-sm text-gray-200";
    let html = "<tr><th>Name</th><th>Avg Hours/Day</th><th>Avg MCQs/Day</th></tr>";
    for (let name in monthlyData) {
      const avgHours = (monthlyData[name].hours / 30).toFixed(1);
      const avgMcqs = (monthlyData[name].mcqs / 30).toFixed(0);
      html += `<tr><td>${name}</td><td>${avgHours}</td><td>${avgMcqs}</td></tr>`;
    }
    table.innerHTML = html;
    document.getElementById("monthly-chart").parentElement.appendChild(table);
  }

  // Render chart function
  function renderCombinedChart(data, canvasId, label) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (!ctx) return;

    const labels = Object.keys(data);
    const hoursData = labels.map(name => data[name].hours);
    const mcqsData = labels.map(name => data[name].mcqs);

    if (ctx.chart) ctx.chart.destroy();

    ctx.chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'Hours',
            data: hoursData,
            backgroundColor: labels.map(name => getColorForUser(name)),
            borderRadius: 8,
            yAxisID: 'y',
          },
          {
            label: 'MCQs',
            data: mcqsData,
            type: 'line',
            borderColor: "#facc15",
            backgroundColor: "#facc15",
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "#ddd" } } },
        scales: {
          x: { ticks: { color: "#ddd" } },
          y: { ticks: { color: "#ddd" }, beginAtZero: true, position: 'left' },
          y1: { ticks: { color: "#ddd" }, beginAtZero: true, position: 'right' }
        }
      }
    });
  }

  // Midnight reset
  setInterval(() => {
    const todayDateISO = new Date().toISOString().split('T')[0];
    if (lastRenderedDate !== todayDateISO) {
      lastRenderedDate = todayDateISO;
      renderAggregatedCharts(logsCache);
    }
  }, 60000); // check every minute
</script>
